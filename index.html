<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºŒå´™åœ‹å°æ‹è²¼æ©Ÿ</title>
    
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è¼‰å…¥ html2canvas (ä¸‹è¼‰åœ–ç‰‡ç”¨) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- è¼‰å…¥ Babel (ç”¨æ–¼åœ¨ç€è¦½å™¨ä¸­ç·¨è­¯ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map: è§£æ±ºæ¨¡çµ„è¼‰å…¥éŒ¯èª¤çš„é—œéµ -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0"
        }
    }
    </script>

    <!-- è¨­å®šç€è¦½å™¨æ¨£å¼é‡ç½®èˆ‡åŸºæœ¬å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #171717; /* neutral-900 */
            margin: 0;
            padding: 0;
            overflow: hidden; /* é˜²æ­¢é›™é‡æ»¾å‹•æ¢ */
        }
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #262626;
        }
        ::-webkit-scrollbar-thumb {
            background: #525252;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #737373;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- ä¸»è¦ç¨‹å¼ç¢¼ï¼šä½¿ç”¨ text/babel èˆ‡ data-type="module" -->
    <script type="text/babel" data-type="module">
        // ç¾åœ¨å¯ä»¥ç›´æ¥ä½¿ç”¨ç°¡æ½”çš„æ¨¡çµ„åç¨±ï¼ŒImport Map æœƒè² è²¬æ‰¾åˆ°æ­£ç¢ºç¶²å€
        import React, { useState, useRef, useEffect, useCallback } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Camera, Download, Image as ImageIcon, Type, Sticker, Layout, Palette, 
            Plus, X, Move, Trash2, Sparkles, Wand2, RefreshCcw, Play, Check, 
            Upload, Scissors, Loader2 
        } from 'lucide-react';

        // å®šç¾©è²¼ç´™åˆ†é¡èˆ‡å…§å®¹
        const STICKER_CATEGORIES = {
            'èŠ±æœµ': ['âœ¿', 'â€', 'â', 'ğŸŒ·', 'ğŸŒ¹', 'ğŸŒ»', 'ğŸŒ¼', 'ğŸŒ¸', 'ğŸ’', 'ğŸŒº', 'ğŸƒ', 'ğŸŒ¿'],
            'é£¾å“': ['ğŸ€', 'ğŸ’', 'ğŸ‘‘', 'ğŸ’', 'â­', 'âœ¨', 'ğŸŒ™', 'ğŸ’–', 'ğŸ”®', 'ğŸ’ ', 'ğŸ’¢', 'ğŸ’«'],
            'é…æˆ´': ['ğŸ‘“', 'ğŸ•¶ï¸', 'ğŸ‘‘', 'ğŸ©', 'ğŸ§¢', 'ğŸ§', 'ğŸ€', 'ğŸ˜·', 'ğŸ§£', 'ğŸ’', 'ğŸ‘¼', 'ğŸ‘¿'],
            'è¡¨æƒ…': ['â˜º', 'ğŸ˜†', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¥º', 'ğŸ˜¡', 'ğŸ˜±', 'ğŸ¥³', 'ğŸ¤©', 'ğŸ¤”', 'ğŸ˜´'],
            'ç¯€æ…¶': ['ğŸ‰', 'ğŸ‚', 'ğŸ„', 'ğŸƒ', 'ğŸ§§', 'ğŸ§¨', 'ğŸ‘»', 'ğŸ•¯ï¸', 'ğŸ…', 'ğŸ‡', 'ğŸ', 'ğŸˆ'],
            'å‹•ç‰©': ['ğŸ±', 'ğŸ¶', 'ğŸ°', 'ğŸ»', 'ğŸ¼', 'ğŸ¦Š', 'ğŸ·', 'ğŸ¦„', 'ğŸ¸', 'ğŸ¯', 'ğŸ™', 'ğŸ¤']
        };

        const PhotoBoothGenerator = () => {
            // ----------------State Management----------------
            const [mode, setMode] = useState('editing'); 
            
            // Layout & Style
            const [layout, setLayout] = useState('strip'); // 'strip', 'grid', 'single'
            const [bgColor, setBgColor] = useState('#ffffff');
            const [bgPattern, setBgPattern] = useState('none'); // 'none', 'dots', 'grid'
            const [frameWidth, setFrameWidth] = useState(24);
            const [borderRadius, setBorderRadius] = useState(0);
            const [isGradient, setIsGradient] = useState(false);
            const [gradientType, setGradientType] = useState('y2k');
            
            // Custom Frames State
            const [customFrames, setCustomFrames] = useState([null, null, null, null]); 
            const [activeFrameIndex, setActiveFrameIndex] = useState(null); 
            
            // Content
            const [photos, setPhotos] = useState({ 0: null, 1: null, 2: null, 3: null });
            const [stickers, setStickers] = useState([]);
            const [activeCategory, setActiveCategory] = useState('èŠ±æœµ'); 
            const [bottomText, setBottomText] = useState('2025.12.25 MEMORIES');
            const [textColor, setTextColor] = useState('#000000');
            const [fontStyle, setFontStyle] = useState('sans');
            
            // Filters (Beauty & Enhance)
            const [filters, setFilters] = useState({
                smooth: 0, 
                enhance: false, 
                brightness: 100, 
            });

            // Background Removal State
            const [isRemovingBg, setIsRemovingBg] = useState({ 0: false, 1: false, 2: false, 3: false });

            // Camera Logic
            const videoRef = useRef(null);
            const canvasRef = useRef(null); 
            const [countdown, setCountdown] = useState(null); 
            const [currentShotIndex, setCurrentShotIndex] = useState(0);
            const [stream, setStream] = useState(null);

            const frameRef = useRef(null);
            const fileInputRef = useRef(null); 
            const frameInputRef = useRef(null); 
            const [activePhotoIndex, setActivePhotoIndex] = useState(null);
            const [uploadingFrameIndex, setUploadingFrameIndex] = useState(null);

            // ----------------Helper Functions: Logic----------------

            const getPhotoSlots = () => {
                if (layout === 'single') return [0];
                return [0, 1, 2, 3];
            };

            const getMaxShots = () => {
                return layout === 'single' ? 1 : 4;
            };

            // ----------------Helper Functions: Background Removal----------------

            const loadBodyPix = async () => {
                if (window.bodyPix) return window.bodyPix;

                if (!document.getElementById('tfjs-script')) {
                    const tfScript = document.createElement('script');
                    tfScript.id = 'tfjs-script';
                    tfScript.src = 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0/dist/tf.min.js';
                    document.body.appendChild(tfScript);
                    await new Promise(resolve => tfScript.onload = resolve);
                }

                if (!document.getElementById('bodypix-script')) {
                    const bpScript = document.createElement('script');
                    bpScript.id = 'bodypix-script';
                    bpScript.src = 'https://cdn.jsdelivr.net/npm/@tensorflow-models/body-pix@2.2.0/dist/body-pix.min.js';
                    document.body.appendChild(bpScript);
                    await new Promise(resolve => bpScript.onload = resolve);
                }

                return window.bodyPix;
            };

            const handleRemoveBackground = async (index, e) => {
                e.stopPropagation(); 
                const imageUrl = photos[index];
                if (!imageUrl) return;

                setIsRemovingBg(prev => ({ ...prev, [index]: true }));

                try {
                    const bodyPix = await loadBodyPix();
                    const net = await bodyPix.load({
                        architecture: 'MobileNetV1',
                        outputStride: 16,
                        multiplier: 0.75,
                        quantBytes: 2
                    });

                    const img = document.createElement('img');
                    img.src = imageUrl;
                    img.crossOrigin = 'anonymous';
                    await new Promise(resolve => img.onload = resolve);

                    const segmentation = await net.segmentPerson(img, {
                        flipHorizontal: false,
                        internalResolution: 'medium',
                        segmentationThreshold: 0.7
                    });

                    const canvas = document.createElement('canvas');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');

                    const foregroundColor = {r: 0, g: 0, b: 0, a: 0};
                    const backgroundColor = {r: 0, g: 0, b: 0, a: 255};
                    const backgroundDarkeningMask = bodyPix.toMask(segmentation, foregroundColor, backgroundColor);

                    ctx.putImageData(backgroundDarkeningMask, 0, 0);
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const pixelData = imageData.data;
                    
                    for (let i = 0; i < pixelData.length; i += 4) {
                        if (segmentation.data[i / 4] === 0) { 
                            pixelData[i + 3] = 0; 
                        }
                    }
                    
                    ctx.putImageData(imageData, 0, 0);

                    const newUrl = canvas.toDataURL('image/png');
                    setPhotos(prev => ({ ...prev, [index]: newUrl }));

                } catch (error) {
                    console.error("Background removal failed:", error);
                    alert("å»èƒŒå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥ç¶²è·¯é€£ç·š (éœ€è¼‰å…¥ AI æ¨¡å‹)");
                } finally {
                    setIsRemovingBg(prev => ({ ...prev, [index]: false }));
                }
            };

            // ----------------Helper Functions: Camera----------------

            const startCamera = async () => {
                try {
                    const mediaStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: "user", width: 1280, height: 720 } 
                    });
                    setStream(mediaStream);
                    setMode('camera'); 
                    setCountdown(null);
                    setCurrentShotIndex(0);
                } catch (err) {
                    alert("ç„¡æ³•å­˜å–ç›¸æ©Ÿï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™è¨­å®šã€‚");
                    console.error(err);
                }
            };

            useEffect(() => {
                if (mode === 'camera' && stream && videoRef.current) {
                    videoRef.current.srcObject = stream;
                }
            }, [mode, stream]);

            const stopCamera = () => {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    setStream(null);
                }
                setMode('editing');
            };

            const startShootingSequence = () => {
                setCurrentShotIndex(0);
                setCountdown(3);
            };

            useEffect(() => {
                let timer;
                if (countdown !== null && countdown > 0) {
                    timer = setTimeout(() => setCountdown(countdown - 1), 1000);
                } else if (countdown === 0) {
                    captureFrame();
                    
                    const maxShots = getMaxShots();
                    
                    if (currentShotIndex < maxShots - 1) {
                        setTimeout(() => {
                            setCurrentShotIndex(prev => prev + 1);
                            setCountdown(3);
                        }, 1000); 
                    } else {
                        setTimeout(() => {
                            stopCamera();
                        }, 800);
                    }
                }
                return () => clearTimeout(timer);
            }, [countdown, currentShotIndex, layout]);

            const captureFrame = () => {
                if (!videoRef.current || !canvasRef.current) return;
                
                const video = videoRef.current;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');

                if (video.videoWidth === 0 || video.videoHeight === 0) return;

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;

                ctx.translate(canvas.width, 0);
                ctx.scale(-1, 1);
                
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageUrl = canvas.toDataURL('image/jpeg');
                setPhotos(prev => ({ ...prev, [currentShotIndex]: imageUrl }));
            };


            // ----------------Helper Functions: Editor----------------

            const handlePhotoClick = (index) => {
                setActivePhotoIndex(index);
                fileInputRef.current.click();
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file && activePhotoIndex !== null) {
                    const imageUrl = URL.createObjectURL(file);
                    setPhotos((prev) => ({ ...prev, [activePhotoIndex]: imageUrl }));
                }
                e.target.value = null;
            };

            const handleFrameSlotClick = (index) => {
                if (customFrames[index]) {
                    setActiveFrameIndex(index);
                } else {
                    setUploadingFrameIndex(index);
                    frameInputRef.current.click();
                }
            };

            const handleFrameFileChange = (e) => {
                const file = e.target.files[0];
                if (file && uploadingFrameIndex !== null) {
                    const imageUrl = URL.createObjectURL(file);
                    setCustomFrames(prev => {
                        const newFrames = [...prev];
                        newFrames[uploadingFrameIndex] = imageUrl;
                        return newFrames;
                    });
                    setActiveFrameIndex(uploadingFrameIndex); 
                }
                e.target.value = null;
            };

            const clearCustomFrame = (index, e) => {
                e.stopPropagation();
                setCustomFrames(prev => {
                    const newFrames = [...prev];
                    newFrames[index] = null;
                    return newFrames;
                });
                if (activeFrameIndex === index) {
                    setActiveFrameIndex(null); 
                }
            };

            const handleStandardStyleChange = (setter, value) => {
                setter(value);
                setActiveFrameIndex(null); 
            };

            const addSticker = (type) => {
                const newSticker = {
                    id: Date.now(),
                    type: type,
                    x: 50,
                    y: 50,
                };
                setStickers([...stickers, newSticker]);
            };

            const removeSticker = (id, e) => {
                e.stopPropagation();
                setStickers(stickers.filter(s => s.id !== id));
            };

            const handleDragStart = (e, id) => e.dataTransfer.setData("stickerId", id);

            const handleDrop = (e) => {
                const id = parseInt(e.dataTransfer.getData("stickerId"));
                if (!id || !frameRef.current) return;
                const rect = frameRef.current.getBoundingClientRect();
                const x = ((e.clientX - rect.left) / rect.width) * 100;
                const y = ((e.clientY - rect.top) / rect.height) * 100;
                setStickers(stickers.map(s => s.id === id ? { ...s, x, y } : s));
                e.preventDefault();
            };

            const handleDragOver = (e) => e.preventDefault();

            const handleDownload = async () => {
                if (!window.html2canvas) {
                    alert("ä¸‹è¼‰å…ƒä»¶å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å€™");
                    return;
                }
                captureImage();
            };

            const captureImage = () => {
                const element = frameRef.current;
                if (!element || !window.html2canvas) return;
                
                // ç‚ºäº†é¿å… html2canvas æˆªåœ–åç§»ï¼Œå…ˆæš«æ™‚é–å®šé«˜åº¦
                const originalStyle = element.style.cssText;
                
                window.html2canvas(element, {
                    scale: 2,
                    backgroundColor: null,
                    useCORS: true,
                    logging: false,
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `photobooth-${Date.now()}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                }).catch(err => {
                    console.error("æˆªåœ–å¤±æ•—", err);
                    alert("åœ–ç‰‡ç”¢ç”Ÿå¤±æ•—ï¼Œè«‹é‡è©¦");
                });
            };

            // ----------------Styles & Filters----------------

            const getImageFilterStyle = () => {
                const blurVal = filters.smooth * 0.05; 
                const brightVal = filters.brightness + (filters.smooth * 1.5); 
                const contrastVal = filters.enhance ? 110 : 100;
                const saturateVal = filters.enhance ? 115 : 100 - (filters.smooth * 1); 

                return `brightness(${brightVal}%) contrast(${contrastVal}%) saturate(${saturateVal}%) blur(${blurVal}px)`;
            };

            const getBackgroundStyle = () => {
                if (activeFrameIndex !== null && customFrames[activeFrameIndex]) {
                    return {
                        backgroundImage: `url(${customFrames[activeFrameIndex]})`,
                        backgroundSize: '100% 100%', 
                        backgroundPosition: 'center',
                        backgroundColor: 'transparent'
                    };
                }

                const layers = [];
                let backgroundColor = bgColor;
                
                if (bgPattern === 'dots') {
                    const dotColor = isGradient ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.1)';
                    layers.push(`radial-gradient(${dotColor} 1px, transparent 1px)`);
                } else if (bgPattern === 'grid') {
                    const gridColor = isGradient ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.1)';
                    layers.push(`linear-gradient(${gridColor} 1px, transparent 1px), linear-gradient(90deg, ${gridColor} 1px, transparent 1px)`);
                }

                if (isGradient) {
                    switch (gradientType) {
                        case 'y2k': layers.push('linear-gradient(135deg, #ff00cc, #333399)'); break;
                        case 'sunset': layers.push('linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)'); break;
                        case 'ocean': layers.push('linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%)'); break;
                        default: break;
                    }
                }

                const style = {
                    backgroundColor: backgroundColor,
                    backgroundSize: (bgPattern === 'dots' || bgPattern === 'grid') ? '20px 20px' : undefined
                };

                if (layers.length > 0) {
                    style.backgroundImage = layers.join(', ');
                }

                return style;
            };

            const getFrameDimensions = () => {
                switch(layout) {
                    case 'strip': return { width: '320px', minHeight: '860px' };
                    case 'grid': return { width: '480px', minHeight: '600px' };
                    case 'single': return { width: '600px', minHeight: '400px' }; 
                    default: return { width: '320px', minHeight: '860px' };
                }
            };

            const getGridLayout = () => {
                switch(layout) {
                    case 'strip': return 'grid-cols-1 flex-1';
                    case 'grid': return 'grid-cols-2 aspect-square';
                    case 'single': return 'grid-cols-1 flex-1';
                    default: return 'grid-cols-1 flex-1';
                }
            };

            // å¦‚æœåœ–ç‰‡è¼‰å…¥å¤±æ•—çš„æ›¿ä»£è™•ç† (Optional)
            const handleImageError = (e) => {
                e.target.style.display = 'none'; 
                // æˆ–è€… e.target.src = 'placeholder.png';
            };

            return (
                <div className="h-screen bg-neutral-900 text-white flex flex-col md:flex-row font-sans selection:bg-pink-500 selection:text-white overflow-hidden">
                
                <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden" />
                <input type="file" ref={frameInputRef} onChange={handleFrameFileChange} accept="image/*" className="hidden" />
                
                <canvas ref={canvasRef} className="hidden" />

                {/* ---------------- CAMERA MODE OVERLAY ---------------- */}
                {mode === 'camera' && (
                    <div className="fixed inset-0 z-50 bg-black flex flex-col items-center justify-center">
                    <div className="relative w-full max-w-4xl aspect-video bg-neutral-800 rounded-lg overflow-hidden shadow-2xl">
                        <video 
                            ref={videoRef} 
                            autoPlay 
                            playsInline 
                            muted
                            className="w-full h-full object-cover transform -scale-x-100" 
                        />
                        
                        <div className="absolute inset-0 pointer-events-none flex flex-col items-center justify-center">
                            {countdown !== null && countdown > 0 && (
                                <div className="text-[12rem] font-bold text-white drop-shadow-[0_0_20px_rgba(255,0,128,0.8)] animate-pulse">
                                    {countdown}
                                </div>
                            )}
                            {countdown === 0 && (
                                <div className="absolute inset-0 bg-white animate-[ping_0.2s_ease-out_1] opacity-50" />
                            )}
                        </div>
                        
                        <div className="absolute top-4 right-4 bg-black/50 px-4 py-2 rounded-full text-white font-mono font-bold">
                            SHOT {currentShotIndex + 1} / {getMaxShots()}
                        </div>
                    </div>

                    <div className="mt-8 flex gap-4">
                        {countdown === null && (
                            <button 
                                onClick={startShootingSequence}
                                className="bg-pink-600 hover:bg-pink-500 text-white px-8 py-4 rounded-full text-xl font-bold flex items-center gap-3 transition transform hover:scale-105 shadow-lg shadow-pink-500/30"
                            >
                                <Camera className="w-6 h-6" /> é–‹å§‹å€’æ•¸æ‹æ” ({getMaxShots()}å¼µ)
                            </button>
                        )}
                        <button 
                            onClick={stopCamera}
                            className="bg-neutral-700 hover:bg-neutral-600 text-white px-6 py-4 rounded-full font-bold transition"
                        >
                            å–æ¶ˆ / è¿”å›
                        </button>
                    </div>
                    </div>
                )}

                {/* ---------------- LEFT PANEL: CONTROLS ---------------- */}
                <div className="w-full md:w-96 bg-neutral-800 border-r border-neutral-700 p-6 flex flex-col gap-6 overflow-y-auto h-full scrollbar-thin scrollbar-thumb-neutral-600 z-10">
                    
                    <div className="flex items-center gap-3 mb-2">
                        {/* æ³¨æ„ï¼šé€™è£¡çš„ src="erlunlogo.png" å¦‚æœåœ¨ Google Sites æ²’æœ‰ä¸Šå‚³å°æ‡‰åœ–ç‰‡å¯èƒ½æœƒç ´åœ– */}
                        <img 
                            src="erlunlogo.png" 
                            alt="Logo" 
                            onError={(e) => {e.target.style.display='none'}}
                            className="w-12 h-12 bg-white rounded-full p-0.5 object-contain shadow-lg shadow-pink-500/20" 
                        />
                        <h1 className="text-2xl font-bold tracking-tight text-white">äºŒå´™åœ‹å°æ‹è²¼æ©Ÿ</h1>
                    </div>

                    {/* 0. Main Actions */}
                    <div className="grid grid-cols-2 gap-3">
                        <button 
                            onClick={startCamera}
                            className="col-span-2 bg-gradient-to-r from-indigo-500 to-purple-600 hover:opacity-90 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition shadow-lg"
                        >
                        <Camera className="w-5 h-5" /> å•Ÿå‹•ç›¸æ©Ÿæ‹æ”
                        </button>
                        <button 
                            onClick={() => setPhotos({0: null, 1: null, 2: null, 3: null})}
                            className="bg-neutral-700 hover:bg-neutral-600 text-xs py-2 rounded flex items-center justify-center gap-1"
                        >
                            <RefreshCcw className="w-3 h-3" /> æ¸…ç©ºç…§ç‰‡
                        </button>
                        <button 
                            onClick={() => setStickers([])}
                            className="bg-neutral-700 hover:bg-neutral-600 text-xs py-2 rounded flex items-center justify-center gap-1"
                        >
                            <Trash2 className="w-3 h-3" /> æ¸…ç©ºè²¼ç´™
                        </button>
                    </div>

                    <hr className="border-neutral-700" />

                    {/* 1. Beauty Filters */}
                    <div className="space-y-4">
                        <div className="flex items-center gap-2 text-sm font-medium text-neutral-300">
                            <Wand2 className="w-4 h-4 text-yellow-400" /> ç¾è‚Œèˆ‡æ¿¾é¡
                        </div>
                        
                        <button 
                            onClick={() => setFilters(prev => ({...prev, enhance: !prev.enhance}))}
                            className={`w-full py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition border ${filters.enhance ? 'bg-pink-500/20 border-pink-500 text-pink-400' : 'bg-neutral-700 border-transparent text-neutral-400'}`}
                        >
                            <Sparkles className="w-4 h-4" /> ä¸€éµç¾åŒ– (å¢è±”/å°æ¯”)
                        </button>

                        <div className="space-y-1">
                            <div className="flex justify-between text-xs text-neutral-400">
                                <span>æŸ”ç„¦ç¾è‚Œç¨‹åº¦</span>
                                <span>{filters.smooth * 10}%</span>
                            </div>
                            <input 
                                type="range" min="0" max="10" 
                                value={filters.smooth} 
                                onChange={(e) => setFilters(prev => ({...prev, smooth: Number(e.target.value)}))}
                                className="w-full accent-pink-500 h-1 bg-neutral-600 rounded-lg appearance-none cursor-pointer"
                            />
                        </div>
                        <div className="space-y-1">
                            <div className="flex justify-between text-xs text-neutral-400">
                                <span>ç•«é¢äº®åº¦</span>
                                <span>{filters.brightness}%</span>
                            </div>
                            <input 
                                type="range" min="80" max="150" 
                                value={filters.brightness} 
                                onChange={(e) => setFilters(prev => ({...prev, brightness: Number(e.target.value)}))}
                                className="w-full accent-yellow-500 h-1 bg-neutral-600 rounded-lg appearance-none cursor-pointer"
                            />
                        </div>
                    </div>

                    <hr className="border-neutral-700" />

                    {/* 2. Layout */}
                    <div className="space-y-3">
                        <div className="flex items-center gap-2 text-sm font-medium text-neutral-300">
                            <Layout className="w-4 h-4" /> ç‰ˆå‹è¨­å®š
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setLayout('strip')} className={`flex-1 py-2 rounded-md text-sm border ${layout === 'strip' ? 'bg-pink-600 border-pink-600 text-white' : 'border-neutral-600 hover:bg-neutral-700'}`}>äººç”Ÿå››æ ¼</button>
                            <button onClick={() => setLayout('grid')} className={`flex-1 py-2 rounded-md text-sm border ${layout === 'grid' ? 'bg-pink-600 border-pink-600 text-white' : 'border-neutral-600 hover:bg-neutral-700'}`}>å››æ ¼æ–¹å¡Š</button>
                            <button onClick={() => setLayout('single')} className={`flex-1 py-2 rounded-md text-sm border ${layout === 'single' ? 'bg-pink-600 border-pink-600 text-white' : 'border-neutral-600 hover:bg-neutral-700'}`}>å–®æ ¼</button>
                        </div>
                    </div>

                    {/* 3. Appearance */}
                    <div className="space-y-4">
                        <div className="flex items-center gap-2 text-sm font-medium text-neutral-300">
                            <Palette className="w-4 h-4" /> é‚Šæ¡†è¨­è¨ˆ
                        </div>

                        <div className="space-y-2">
                            <div className="text-xs text-neutral-400 flex justify-between">
                                <span>è‡ªè¨‚é‚Šæ¡†ä¸Šå‚³ (é»é¸ä½¿ç”¨)</span>
                            </div>
                            <div className="grid grid-cols-4 gap-2">
                                {customFrames.map((frame, idx) => (
                                    <div 
                                        key={idx}
                                        className={`relative aspect-square rounded-lg border-2 cursor-pointer overflow-hidden group bg-neutral-700 flex items-center justify-center transition ${activeFrameIndex === idx && frame ? 'border-pink-500 ring-2 ring-pink-500/50' : 'border-neutral-600 hover:border-neutral-500'}`}
                                        onClick={() => handleFrameSlotClick(idx)}
                                    >
                                        {frame ? (
                                            <>
                                                <img src={frame} alt="frame" className="w-full h-full object-cover" />
                                                <button 
                                                    onClick={(e) => clearCustomFrame(idx, e)}
                                                    className="absolute top-0 right-0 p-0.5 bg-black/60 hover:bg-red-500 text-white opacity-0 group-hover:opacity-100 transition rounded-bl"
                                                >
                                                    <X className="w-3 h-3" />
                                                </button>
                                            </>
                                        ) : (
                                            <div className="flex flex-col items-center gap-1 text-neutral-400 group-hover:text-white">
                                                <Plus className="w-5 h-5" />
                                                <span className="text-[9px]">ä¸Šå‚³</span>
                                            </div>
                                        )}
                                        
                                        {activeFrameIndex === idx && frame && (
                                            <div className="absolute inset-0 border-2 border-pink-500 rounded-lg pointer-events-none" />
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>

                        <hr className="border-neutral-700/50" />
                        
                        <div className={`transition-opacity duration-300 ${activeFrameIndex !== null ? 'opacity-50 pointer-events-none grayscale' : 'opacity-100'}`}>
                            <div className="flex items-center justify-between text-xs text-neutral-400 mb-2">
                                <span>ä¸€èˆ¬èƒŒæ™¯é¡è‰²/æ¼¸å±¤</span>
                                <button 
                                    onClick={() => handleStandardStyleChange(setIsGradient, !isGradient)} 
                                    className={`w-10 h-5 rounded-full relative transition-colors ${isGradient ? 'bg-pink-500' : 'bg-neutral-600'}`}
                                >
                                <div className={`absolute top-1 w-3 h-3 bg-white rounded-full transition-all ${isGradient ? 'left-6' : 'left-1'}`} />
                                </button>
                            </div>

                            {isGradient ? (
                                <div className="grid grid-cols-3 gap-2">
                                    {['y2k', 'sunset', 'ocean'].map(g => (
                                    <button 
                                        key={g}
                                        onClick={() => handleStandardStyleChange(setGradientType, g)}
                                        className={`h-8 rounded ring-2 ring-offset-2 ring-offset-neutral-800 ${gradientType === g ? 'ring-white' : 'ring-transparent'}`}
                                        style={{
                                        background: g === 'y2k' ? 'linear-gradient(135deg, #ff00cc, #333399)' :
                                                    g === 'sunset' ? 'linear-gradient(to right, #fbc2eb, #a6c1ee)' :
                                                    'linear-gradient(120deg, #84fab0, #8fd3f4)'
                                        }}
                                    />
                                    ))}
                                </div>
                            ) : (
                                <div className="flex gap-2 items-center">
                                <input 
                                    type="color" 
                                    value={bgColor} 
                                    onChange={(e) => handleStandardStyleChange(setBgColor, e.target.value)} 
                                    className="w-8 h-8 rounded cursor-pointer bg-transparent border-none" 
                                />
                                <span className="text-xs text-neutral-400">{bgColor}</span>
                                </div>
                            )}
                            
                            <div className="flex gap-2 text-xs mt-3">
                                {['none', 'dots', 'grid'].map(p => (
                                    <button
                                        key={p}
                                        onClick={() => handleStandardStyleChange(setBgPattern, p)}
                                        className={`flex-1 py-1 rounded border ${bgPattern === p ? 'bg-neutral-600 border-white text-white' : 'border-neutral-600 text-neutral-400'}`}
                                    >
                                        {p === 'none' ? 'ç´”è‰²' : p === 'dots' ? 'åœ“é»' : 'æ ¼ç´‹'}
                                    </button>
                                ))}
                            </div>
                        </div>

                        <div className="space-y-1">
                            <div className="flex justify-between text-xs text-neutral-400">
                            <span>é‚Šæ¡†å¯¬åº¦ (ç…§ç‰‡é–“è·)</span><span>{frameWidth}px</span>
                            </div>
                            <input type="range" min="0" max="60" value={frameWidth} onChange={(e) => setFrameWidth(Number(e.target.value))} className="w-full accent-pink-500 h-1 bg-neutral-600 rounded-lg appearance-none cursor-pointer" />
                        </div>
                        
                        <div className="space-y-1">
                            <div className="flex justify-between text-xs text-neutral-400">
                            <span>ç…§ç‰‡åœ“è§’</span><span>{borderRadius}px</span>
                            </div>
                            <input type="range" min="0" max="50" value={borderRadius} onChange={(e) => setBorderRadius(Number(e.target.value))} className="w-full accent-pink-500 h-1 bg-neutral-600 rounded-lg appearance-none cursor-pointer" />
                        </div>
                    </div>

                    {/* 4. Text & Stickers */}
                    <div className="space-y-3">
                        <div className="flex items-center gap-2 text-sm font-medium text-neutral-300">
                            <Type className="w-4 h-4" /> æ–‡å­—èˆ‡è£é£¾
                        </div>
                        <input type="text" value={bottomText} onChange={(e) => setBottomText(e.target.value)} className="w-full bg-neutral-700 border border-neutral-600 rounded px-3 py-2 text-sm focus:outline-none focus:border-pink-500" />
                        <div className="flex justify-between items-center">
                            <input type="color" value={textColor} onChange={(e) => setTextColor(e.target.value)} className="w-6 h-6 rounded cursor-pointer bg-transparent border-none" />
                            <div className="flex bg-neutral-700 rounded p-1">
                                {['sans', 'serif', 'mono'].map(f => (
                                <button key={f} onClick={() => setFontStyle(f)} className={`px-2 py-1 text-xs rounded ${fontStyle === f ? 'bg-neutral-500 text-white' : 'text-neutral-400'}`}>
                                    {f === 'sans' ? 'A' : f === 'serif' ? 'T' : 'M'}
                                </button>
                                ))}
                            </div>
                        </div>
                        
                        <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-neutral-600">
                            {Object.keys(STICKER_CATEGORIES).map(cat => (
                            <button
                                key={cat}
                                onClick={() => setActiveCategory(cat)}
                                className={`flex-shrink-0 px-3 py-1 rounded-full text-xs font-bold transition whitespace-nowrap ${activeCategory === cat ? 'bg-pink-500 text-white' : 'bg-neutral-700 text-neutral-400 hover:bg-neutral-600'}`}
                            >
                                {cat}
                            </button>
                            ))}
                        </div>
                        
                        <div className="grid grid-cols-4 gap-2 pt-1 h-32 overflow-y-auto scrollbar-thin scrollbar-thumb-neutral-600 content-start">
                            {STICKER_CATEGORIES[activeCategory].map(s => (
                            <button key={s} onClick={() => addSticker(s)} className="bg-neutral-700 hover:bg-neutral-600 rounded p-2 text-xl flex items-center justify-center transition aspect-square">
                                {s}
                            </button>
                            ))}
                        </div>
                    </div>

                    <div className="mt-auto pt-6">
                        <button onClick={handleDownload} className="w-full bg-pink-600 hover:bg-pink-700 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition shadow-lg shadow-pink-900/20">
                            <Download className="w-5 h-5" /> ä¸‹è¼‰æˆå“åœ–ç‰‡
                        </button>
                    </div>
                </div>

                {/* ---------------- RIGHT PANEL: PREVIEW ---------------- */}
                <div className="flex-1 bg-neutral-950 flex items-center justify-center p-8 overflow-auto relative bg-[radial-gradient(#222_1px,transparent_1px)] [background-size:24px_24px]">
                    
                    <div 
                        ref={frameRef}
                        onDrop={handleDrop}
                        onDragOver={handleDragOver}
                        style={{ 
                            ...getBackgroundStyle(), 
                            ...getFrameDimensions(), 
                            padding: `${frameWidth}px`,
                            position: 'relative',
                            boxShadow: '0 25px 60px -15px rgba(0, 0, 0, 0.7)'
                        }}
                        className="transition-all duration-500 ease-in-out flex flex-col items-center"
                    >
                        <div className={`w-full grid gap-[12px] ${getGridLayout()}`}>
                            {getPhotoSlots().map((index) => (
                            <div 
                                key={index}
                                onClick={() => handlePhotoClick(index)}
                                className="relative bg-black/20 overflow-hidden cursor-pointer group hover:opacity-90 transition border border-white/10"
                                style={{ 
                                borderRadius: `${borderRadius}px`,
                                backgroundColor: 'rgba(0,0,0,0.2)'
                                }}
                            >
                                {photos[index] ? (
                                <img 
                                    src={photos[index]} 
                                    alt="shot" 
                                    className="w-full h-full object-cover" 
                                    style={{
                                        filter: getImageFilterStyle() 
                                    }}
                                />
                                ) : (
                                <div className="w-full h-full flex flex-col items-center justify-center text-white/40">
                                    <Plus className="w-8 h-8 mb-1 opacity-50" />
                                    <span className="text-xs font-medium">Pic {index + 1}</span>
                                </div>
                                )}
                                
                                <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center transition-opacity z-10 gap-3">
                                <div className="text-white text-xs font-bold flex gap-1 items-center bg-white/20 px-3 py-1.5 rounded-full hover:bg-white/30 backdrop-blur-sm transition">
                                    <ImageIcon className="w-3 h-3"/> æ›ç…§ç‰‡
                                </div>
                                
                                {photos[index] && (
                                    <button 
                                        onClick={(e) => handleRemoveBackground(index, e)}
                                        className="text-white text-xs font-bold flex gap-1 items-center bg-pink-500/80 px-3 py-1.5 rounded-full hover:bg-pink-600/90 backdrop-blur-sm transition disabled:opacity-50"
                                        disabled={isRemovingBg[index]}
                                    >
                                        {isRemovingBg[index] ? <Loader2 className="w-3 h-3 animate-spin"/> : <Scissors className="w-3 h-3"/>}
                                        {isRemovingBg[index] ? "è™•ç†ä¸­" : "å»èƒŒ"}
                                    </button>
                                )}
                                </div>
                            </div>
                            ))}
                        </div>

                        <div 
                            className="mt-6 text-center w-full break-words z-20 relative"
                            style={{ 
                            color: textColor,
                            fontFamily: fontStyle === 'mono' ? 'monospace' : fontStyle === 'serif' ? 'serif' : 'sans-serif',
                            fontWeight: 'bold',
                            fontSize: layout === 'strip' ? '1.2rem' : '1.1rem',
                            letterSpacing: '0.05em',
                            textShadow: '0 1px 2px rgba(0,0,0,0.1)'
                            }}
                        >
                            {bottomText}
                        </div>

                        {stickers.map((s) => (
                            <div
                            key={s.id}
                            draggable
                            onDragStart={(e) => handleDragStart(e, s.id)}
                            style={{
                                position: 'absolute',
                                left: `${s.x}%`,
                                top: `${s.y}%`,
                                transform: 'translate(-50%, -50%)',
                                cursor: 'move',
                                fontSize: '3.5rem',
                                userSelect: 'none',
                                filter: 'drop-shadow(2px 2px 0px rgba(0,0,0,0.1))'
                            }}
                            className="group z-30 hover:scale-110 transition-transform active:scale-95"
                            >
                            {s.type}
                            <button 
                                onClick={(e) => removeSticker(s.id, e)}
                                className="absolute -top-3 -right-3 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover:opacity-100 transition shadow-sm transform scale-75"
                            >
                                <X className="w-4 h-4" />
                            </button>
                            </div>
                        ))}

                        <div className="absolute bottom-2 right-3 opacity-40 text-[9px] font-sans text-white pointer-events-none mix-blend-overlay font-bold tracking-widest">
                            ERLUN BOOTH
                        </div>

                    </div>
                </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<PhotoBoothGenerator />);
    </script>
</body>
</html>